# VRChat外部通知オーバーレイシステム - UX/ユーザー体験視点BDD

# ============================================================
# Feature 1: VR空間内での通知表示体験
# ============================================================

Feature: VR空間内での通知表示体験
  VRChatユーザーとして
  VR空間の没入感を維持しながら外部アプリの通知を確認したい
  そのために通知は視界の邪魔にならない位置に、適切な視認性で表示される必要がある

  Background:
    Given SteamVRが起動している
    And 本アプリ「VRNotify」がSteamVRオーバーレイとして登録されている
    And Discordアカウントが接続済みである
    And VRChatが起動しワールドに入室している

  # --- 通知の表示位置 ---

  Scenario: デフォルトの通知表示位置はHMD追従の視界上部である
    Given 通知の表示位置が「HMD追従」に設定されている
    When Discordでメンション付きメッセージを受信する
    Then 通知がHMDの視界上部（上方15度、前方1.2m）にオーバーレイとして表示される
    And 通知はユーザーの頭の動きに追従する
    And 通知は視界の中央を遮らない位置に表示される

  Scenario: 手首固定モードでの通知表示
    Given 通知の表示位置が「左手首」に設定されている
    When Discordでメンション付きメッセージを受信する
    Then 左コントローラーの上面にバッジアイコン（未読数）が表示される
    And ユーザーが左手首を顔の方に向けると通知詳細がポップアップ表示される

  Scenario: HMD追従モードでの通知は頭を激しく動かしても安定する
    Given 通知の表示位置が「HMD追従」に設定されている
    And 通知が1件表示されている
    When ユーザーが素早く頭を左右に振る
    Then 通知はスムーズに追従し、ちらつきや遅延が発生しない
    And 通知の追従にはイージング（SmoothDamp相当）が適用されている

  Scenario: ワールド固定モードでの通知表示
    Given 通知の表示位置が「ワールド固定」に設定されている
    When Discordでメンション付きメッセージを受信する
    Then 通知が受信時のユーザー正面1.5m、目線の高さに空間固定で表示される
    And ユーザーが移動しても通知は元の位置に留まる

  # --- 通知の視認性 ---

  Scenario: 通知のデフォルトの見た目
    When Discordからメンション付きメッセージを受信する
    Then 通知カードは幅0.3m x 高さ0.08mのサイズで表示される
    And 背景色は半透明の暗色（#1a1a2e、透過度80%）である
    And テキストは白色（#FFFFFF）でNoto Sans JP相当のフォント、VR内で読みやすい14pt相当である
    And 通知カードの左端にサービスアイコン（Discord/Slack）が表示される
    And 送信者名が太字で、メッセージ本文がその下に1行で表示される
    And メッセージが長い場合は末尾が「...」で省略される

  Scenario: 明るいワールドでも暗いワールドでも通知が読める
    Given ユーザーが明るい屋外ワールドにいる
    When 通知が表示される
    Then 通知カードの背景コントラストにより白文字が視認可能である
    And 通知カードに薄い縁取り（1px、サービスカラー）が付いている

  Scenario: 通知のサイズをユーザーがカスタマイズできる
    Given 設定画面で通知サイズを「大」に変更している
    When 通知が表示される
    Then 通知カードは幅0.45m x 高さ0.12mで表示される
    And フォントサイズも比例して拡大される

  # --- 通知の表示時間とアニメーション ---

  Scenario: 通知はデフォルト5秒表示後にフェードアウトする
    When Discordからメッセージを受信する
    Then 通知が右からスライドインで表示される（0.3秒）
    And 5秒間表示が維持される
    And 0.5秒かけてフェードアウトで消える
    And フェードアウト後はオーバーレイが完全に非表示になる

  Scenario: 通知の表示時間をユーザーが変更できる
    Given 設定画面で通知表示時間を「10秒」に変更している
    When 通知を受信する
    Then 通知は10秒間表示された後にフェードアウトする

  Scenario: 重要度「高」の通知は表示時間が延長される
    Given Discordのメンション通知の重要度が「高」に設定されている
    When Discordで@メンション付きメッセージを受信する
    Then 通知は通常の2倍の時間（デフォルト10秒）表示される
    And 通知カードの左辺にオレンジ色のアクセントラインが付く

  # --- 複数通知のスタック表示 ---

  Scenario: 複数通知が同時に届いた場合のスタック表示
    When Discordから3件の通知が1秒以内に届く
    Then 最新の通知が一番上に表示される
    And 2番目の通知は1番目の下に少しずらして（Y軸-0.09m）表示される
    And 3番目の通知はさらに下に表示される
    And 各通知カードの透過度は下にいくほど高くなる（奥の通知ほど薄い）

  Scenario: スタック上限を超えた場合の処理
    Given スタック表示の上限が「5件」に設定されている
    When 6件目の通知が届く
    Then 最も古い通知が即座にフェードアウトする
    And 6件目の通知が一番上に表示される
    And スタック下部に「+1件の未読」というカウンターが表示される

  Scenario: スタック中の個別通知がタイムアウトで消える
    Given 3件の通知がスタック表示されている
    When 最も古い通知の表示時間が経過する
    Then その通知だけがフェードアウトする
    And 残りの通知が上方向にスライドして詰められる

  # --- 没入感の維持 ---

  Scenario: VRChatのカメラ撮影中は通知を一時停止する
    Given 通知一時停止トリガーに「VRChatカメラ起動中」が含まれている
    And VRChatのカメラモードが有効である
    When 通知を受信する
    Then 通知は表示されずキューに保存される
    And カメラモードが終了した時点でキュー内の通知がまとめて表示される

  Scenario: 配信モードでの通知内容マスク
    Given 配信モードが「有効」に設定されている
    When 通知を受信する
    Then 通知の送信者名は「***」でマスクされる
    And メッセージ本文も先頭5文字のみ表示され残りは「...」で省略される

  Scenario: 通知音はVRChatのワールドBGMを邪魔しない
    Given 通知音が「有効」に設定されている
    And 通知音量が「30%」に設定されている
    When 通知を受信する
    Then 短い通知音（0.3秒以内）が設定音量で再生される
    And 通知音はSteamVRの通知サウンドチャンネルから出力される
