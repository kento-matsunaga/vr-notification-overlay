# VRChat外部通知オーバーレイシステム - インタラクション・セットアップ・日常フロー

# ============================================================
# Feature 2: 通知のインタラクション
# ============================================================

Feature: VR空間内での通知インタラクション
  VRChatユーザーとして
  コントローラー操作で通知を管理したい
  そのために直感的なジェスチャーやボタン操作で通知を制御できる必要がある

  Background:
    Given SteamVRが起動している
    And 本アプリ「VRNotify」が動作中である
    And 通知が1件以上表示されている

  # --- 通知を閉じる操作 ---

  Scenario: コントローラーのレーザーポインターで通知をスワイプして閉じる
    Given 通知が1件表示されている
    When ユーザーが右コントローラーでトリガーを引きながら通知を右方向にスワイプする
    Then 通知が右方向にスライドアウトして消える
    And 通知は既読状態になる

  Scenario: 特定のボタンで全通知を一括クリアする
    Given 3件の通知がスタック表示されている
    When ユーザーが左コントローラーのBボタン（設定可能）を長押し（1秒）する
    Then すべての通知が同時にフェードアウトする
    And すべての通知が既読状態になる

  Scenario: 通知をスワイプせずに放置した場合は自動で消える
    Given 通知が1件表示されている
    When 表示時間（デフォルト5秒）が経過する
    Then 通知はフェードアウトで消える
    And 通知は「未読」状態のまま履歴に残る

  # --- 通知の詳細表示 ---

  Scenario: 通知をタップして詳細を表示する
    Given Discordのメッセージ通知が1件表示されている
    And メッセージ本文が省略されている
    When ユーザーが右コントローラーのレーザーポインターで通知をタップ（トリガー短押し）する
    Then 通知カードが拡大表示される（幅0.5m x 高さ0.2m）
    And メッセージ本文が全文表示される
    And 送信者のアバターアイコンが表示される
    And 送信時刻が表示される
    And 「閉じる」ボタンが右上に表示される

  Scenario: 詳細表示中に別の通知が届いた場合
    Given 通知の詳細表示が開いている
    When 新しい通知が届く
    Then 新しい通知は詳細表示の上部にコンパクトなバナーとして表示される
    And 詳細表示は閉じられない

  # --- Do Not Disturb（おやすみ）モード ---

  Scenario: DNDモードを有効にすると通知が表示されなくなる
    Given DNDモードが「無効」である
    When ユーザーが手首メニューからDNDモードを「有効」にする
    Then 「おやすみモード ON」という確認がHMD視界に1回表示される
    And 以降の通知はすべて非表示になる
    And 非表示の通知は履歴に蓄積される

  Scenario: DNDモード中でも緊急通知は表示される
    Given DNDモードが「有効」である
    And 「緊急通知のみ許可」が有効である
    And Discord上の特定ユーザー「重要フレンド」が緊急連絡先に登録されている
    When 「重要フレンド」からDMを受信する
    Then 通常の通知とは異なる赤色アクセントの通知が表示される
    And 通知音が鳴る

  Scenario: DNDモードを解除すると蓄積通知のサマリーが表示される
    Given DNDモードが「有効」である
    And 8件の通知が蓄積されている
    When ユーザーがDNDモードを「無効」にする
    Then 「おやすみモード OFF - 8件の未読があります」と表示される
    And 蓄積された通知が一括で表示されるのではなくサマリーカードとして1枚表示される
    And サマリーカードにはサービス別の件数（例：Discord 5件、Slack 3件）が表示される

  Scenario: スケジュールによるDND自動切り替え
    Given DNDスケジュールが「毎日 23:00 - 07:00」に設定されている
    And 現在時刻が22:59である
    When 時刻が23:00になる
    Then DNDモードが自動的に「有効」になる
    And 「スケジュールDND ON」という控えめな通知が表示される

  # --- 通知の既読管理 ---

  Scenario: 通知を手動で既読にする
    Given 未読通知が3件ある
    When ユーザーが通知を右スワイプで閉じる
    Then その通知は「既読」状態になる
    And 手首のバッジカウンターが2に減る

  Scenario: 通知履歴から過去の通知を確認する
    Given 過去1時間に10件の通知を受信している
    When ユーザーが手首メニューから「履歴」を選択する
    Then 時系列順で通知一覧がスクロール可能なパネルとして表示される
    And 未読通知にはドットインジケーターが付いている
    And 各通知のサービス名、送信者名、時刻、本文プレビューが表示される

# ============================================================
# Feature 3: アプリの初期セットアップ
# ============================================================

Feature: アプリの初期セットアップ
  新規ユーザーとして
  できるだけ簡単にDiscordやSlackの通知を受け取れるようにしたい
  そのためにセットアップはデスクトップで完結し、VR内での複雑な操作を不要にする

  # --- Discordの接続 ---

  Scenario: Discordアカウントを初めて接続する
    Given VRNotifyを初めて起動している
    And デスクトップのセットアップウィザードが表示されている
    When 「Discordを接続」ボタンをクリックする
    Then デフォルトブラウザでDiscord OAuth2認証画面が開く
    And 要求される権限スコープは「メッセージの読み取り」「ギルド情報の読み取り」である
    And アプリ側に「ブラウザで認証を完了してください...」と待機表示がされる

  Scenario: 通知対象のDiscordチャンネルを選択する
    Given Discord接続が完了している
    And サーバー一覧が表示されている
    When ユーザーが特定のサーバーを展開する
    Then チャンネル一覧がチェックボックス付きで表示される
    And デフォルトではすべてのチャンネルが「オフ」になっている

  Scenario: Discord認証が失敗した場合
    Given ブラウザでDiscord OAuth2認証画面が表示されている
    When ユーザーが「キャンセル」をクリックする
    Then アプリに「認証がキャンセルされました」と表示される
    And 「再試行」ボタンが表示される
    And Discordなしでも他のサービスのセットアップに進める

  # --- Slackの接続 ---

  Scenario: Slackワークスペースを接続する
    Given セットアップウィザードの「サービス追加」画面が表示されている
    When 「Slackを接続」ボタンをクリックする
    Then ブラウザでSlack OAuth2認証画面が開く
    And ワークスペースの選択画面が表示される

  Scenario: 複数のSlackワークスペースを接続する
    Given 1つ目のSlackワークスペース「チームA」が接続済みである
    When 「Slackワークスペースを追加」をクリックする
    Then 新しいOAuth2認証フローが開始される
    When 2つ目のワークスペース「チームB」の認証を完了する
    Then 両方のワークスペースが接続一覧に表示される

  # --- VR内 vs デスクトップでの設定 ---

  Scenario: 初期セットアップはデスクトップで完了する
    Given ユーザーがVRNotifyを初めて起動した
    Then デスクトップウィンドウにセットアップウィザードが表示される
    And VR内ではセットアップウィザードは表示されない
    And ウィザードは「サービス接続」→「チャンネル選択」→「表示設定」→「完了」の4ステップである

  Scenario: 基本設定はVR内のオーバーレイメニューからも変更できる
    Given 初期セットアップが完了している
    And VR内で手首メニューを開いている
    When 「設定」を選択する
    Then 以下の設定項目がVR内で変更可能である:
      | 設定項目         | 変更可能 |
      | 通知表示位置     | はい     |
      | 通知サイズ       | はい     |
      | 通知表示時間     | はい     |
      | 通知音量         | はい     |
      | DNDモード        | はい     |
      | サービス接続追加 | いいえ   |
      | チャンネル選択   | いいえ   |

# ============================================================
# Feature 4: 日常的な使用フロー
# ============================================================

Feature: 日常的なVRChatセッションでの使用フロー
  VRChatを日常的に利用するユーザーとして
  通知システムの存在をあまり意識せず自然に使いたい
  そのためにアプリは自動起動し、状況に応じて適切に動作する必要がある

  Background:
    Given 初期セットアップが完了している
    And Discordアカウントが接続済みである

  # --- VRChat起動前の準備 ---

  Scenario: SteamVR起動時にVRNotifyが自動起動する
    Given VRNotifyの自動起動設定が「有効」である
    When SteamVRを起動する
    Then VRNotifyがバックグラウンドプロセスとして自動的に起動する
    And システムトレイにVRNotifyのアイコンが表示される
    And SteamVRのオーバーレイ一覧にVRNotifyが登録される
    And HMD内に「VRNotify 起動しました」と1回だけ控えめに表示される

  Scenario: SteamVRなしでデスクトップモードで起動する
    Given SteamVRが起動していない
    When VRNotifyを起動する
    Then デスクトップ専用モードで起動する
    And 「SteamVRが検出されません。デスクトップモードで動作します」と表示される
    And 通知はWindowsのトースト通知として表示される

  # --- VRChat中の通知受信 ---

  Scenario: VRChatでフレンドと会話中にDiscord通知を受信する
    Given ユーザーがVRChatのワールドでフレンドと会話中である
    When Discordのサーバーチャンネルでメンションされる
    Then 視界上部に控えめな通知バナーが表示される
    And 通知音は短く小さい音量で再生される
    And 5秒後に自動で消える

  Scenario: VRChatのワールド移動中は通知を一時停止する
    Given 通知のワールド移動中一時停止が「有効」である
    When VRChatでワールド移動のローディングが開始される
    Then ローディング中は通知が一時停止される
    When ワールドの読み込みが完了する
    Then 一時停止中に受信した通知がまとめて表示される

  # --- VRChat終了時 ---

  Scenario: SteamVR終了時にVRNotifyが自動終了する
    Given VRNotifyが動作中である
    When SteamVRを終了する
    Then VRNotifyがグレースフルに終了する
    And 未読通知の状態がローカルに保存される

  Scenario: 次回起動時に前回の未読状態が復元される
    Given 前回終了時に未読通知が5件あった
    When VRNotifyを起動する
    Then 手首バッジに未読カウンター「5」が表示される
    And 履歴画面から前回の未読通知を確認できる
    And 前回の通知はポップアップでは表示されない（バッジカウンターのみ）
