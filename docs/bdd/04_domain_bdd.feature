# VR通知オーバーレイシステム - ビジネスドメイン視点BDD

# ============================================================
# Feature 1: 通知ソース管理
# ============================================================

Feature: 通知ソースの管理
  VRユーザーとして
  外部メッセージングサービスを通知ソースとして登録・管理したい
  VR中に重要な通知を見逃さないために

  Background:
    Given システムが起動している
    And SteamVRが起動している

  Scenario: Discordボットトークンで通知ソースを追加する
    Given 通知ソースが1つも登録されていない
    When ユーザーがDiscordの通知ソースを追加する
    And ボットトークン "valid-bot-token-123" を入力する
    Then 通知ソース "Discord" が登録される
    And 接続状態が "接続中" になる
    And 接続が成功すると接続状態が "接続済" になる

  Scenario: 無効なトークンで通知ソース追加に失敗する
    When ユーザーがDiscordの通知ソースを追加する
    And ボットトークン "invalid-token" を入力する
    Then 認証エラーが表示される
    And 通知ソースは登録されない

  Scenario: Slackアプリトークンで通知ソースを追加する
    When ユーザーがSlackの通知ソースを追加する
    And アプリトークン "xoxb-valid-slack-token" を入力する
    Then 通知ソース "Slack" が登録される
    And 接続状態が "接続済" になる

  Scenario: 同一サービスの複数アカウントを追加する
    Given Discord通知ソース "個人用Discord" が登録されている
    When ユーザーがDiscordの通知ソースをもう1つ追加する
    And 表示名を "仕事用Discord" に設定する
    And 有効なボットトークンを入力する
    Then 通知ソース "仕事用Discord" が追加で登録される
    And 通知ソースが合計2件になる

  Scenario: 通知ソースを削除する
    Given Discord通知ソース "個人用Discord" が登録されている
    When ユーザーが "個人用Discord" を削除する
    And 削除の確認ダイアログで「はい」を選択する
    Then 通知ソース "個人用Discord" が削除される
    And 関連する認証情報も削除される
    And 関連するフィルタルールも無効化される

  Scenario: 通知ソースを一時的に無効化する
    Given Discord通知ソース "個人用Discord" が接続済である
    When ユーザーが "個人用Discord" を無効化する
    Then "個人用Discord" の接続が切断される
    And "個人用Discord" からの通知は受信されなくなる

  Scenario: 接続が予期せず切断された場合に自動再接続する
    Given Discord通知ソース "個人用Discord" が接続済である
    When ネットワーク障害により接続が切断される
    Then 接続状態が "再接続中" になる
    And 1秒後に再接続を試行する
    And 再接続に失敗した場合は2秒後に再試行する
    And 指数バックオフで最大60秒間隔まで広がる

  Scenario: 自動再接続が上限回数に達した場合
    Given Discord通知ソース "個人用Discord" が再接続中である
    And 再接続試行が10回失敗している
    When 10回目の再接続も失敗する
    Then 接続状態が "切断" になる
    And VRオーバーレイに接続失敗通知が表示される

  Scenario: サードパーティ製ソースアダプターをロードする
    Given "Chatwork" 用のアダプタープラグイン "chatwork-adapter.dll" が
          プラグインディレクトリに配置されている
    When システムが起動する
    Then 通知ソースの追加画面に "Chatwork" が選択肢として表示される

  Scenario: 不正なプラグインをロードしない
    Given 不正なDLLファイル "malformed-plugin.dll" が
          プラグインディレクトリに配置されている
    When システムが起動する
    Then プラグインの読み込みエラーがログに記録される
    And システムは正常に起動を継続する

# ============================================================
# Feature 2: 通知フィルタリング・ルールエンジン
# ============================================================

Feature: 通知フィルタリングとルールエンジン
  VRユーザーとして
  受信する通知を細かくフィルタリングしたい
  VR体験を中断する不要な通知を排除するために

  Background:
    Given Discord通知ソース "個人用Discord" が接続済である
    And アクティブプロファイル "デフォルト" が適用されている

  Scenario: 特定のDiscordサーバーからの通知のみ許可する
    Given フィルタチェーンのデフォルトポリシーが "拒否" である
    And サーバー "開発チーム" を許可するフィルタルールが設定されている
    When サーバー "開発チーム" のチャンネル "general" にメッセージが投稿される
    Then 通知イベントがフィルタを通過する
    And 通知カードが生成される

  Scenario: 除外サーバーからの通知を遮断する
    Given フィルタチェーンのデフォルトポリシーが "許可" である
    And サーバー "雑談部屋" を除外するフィルタルールが設定されている
    When サーバー "雑談部屋" のチャンネル "random" にメッセージが投稿される
    Then 通知イベントがフィルタで遮断される
    And 通知カードは生成されない

  Scenario: メンション通知を高優先度として分類する
    Given メンション種別 "ダイレクトメンション" を高優先度とするルールが設定されている
    When 自分宛の@メンションを含むメッセージが受信される
    Then 通知カードが優先度 "高" で生成される

  Scenario: ユーザー定義キーワードにマッチする通知
    Given キーワード "本番障害" を中優先度とするフィルタルールが設定されている
    When メッセージ本文に "本番障害が発生しました" が含まれる通知が受信される
    Then 通知カードが優先度 "中" で生成される

  Scenario: 特定の送信者をミュートする
    Given 送信者 "SpamBot#1234" を除外するフィルタルールが設定されている
    When "SpamBot#1234" からメッセージが受信される
    Then 通知イベントがフィルタで遮断される

  Scenario: VIP送信者からの通知を常に高優先度にする
    Given 送信者 "上司#5678" を高優先度とするフィルタルールが設定されている
    When "上司#5678" から通常メッセージが受信される
    Then 通知カードが優先度 "高" で生成される

  Scenario: 業務時間外は通知を低優先度に下げる
    Given 時間帯ルール "09:00-18:00以外は低優先度" が設定されている
    And 現在時刻が "22:30" である
    When メッセージが受信される
    Then 通知カードの優先度が "低" に設定される

  Scenario: 複数のルールが異なる優先度を指示する場合は最も高い優先度を採用する
    Given 送信者 "上司#5678" を高優先度とするルールが設定されている
    And 時間帯ルール "18:00以降は低優先度" が設定されている
    And 現在時刻が "20:00" である
    When "上司#5678" からメッセージが受信される
    Then 通知カードが優先度 "高" で生成される

  Scenario: フィルタチェーンは上から順に評価し最初のマッチで確定する
    Given 以下のフィルタルールが順に設定されている:
      | 順序 | 種別       | 条件         | 判定 |
      | 1    | チャンネル  | #important   | 許可 |
      | 2    | サーバー    | 雑談部屋      | 拒否 |
    When サーバー "雑談部屋" のチャンネル "#important" にメッセージが投稿される
    Then ルール1がマッチし通知は許可される

# ============================================================
# Feature 3: 通知ライフサイクル
# ============================================================

Feature: 通知のライフサイクル管理
  VRユーザーとして
  通知が受信から消去まで適切に管理されることを期待する

  Background:
    Given システムが起動している
    And SteamVRが起動している
    And Discord通知ソース "個人用Discord" が接続済である

  Scenario: 通知が正常フローで受信から表示まで処理される
    Given 表示スロットに空きがある
    When Discord の "general" チャンネルに自分宛のメンションが投稿される
    Then 通知イベントが生成される
    And フィルタチェーンで評価される
    And 優先度 "高" の通知カードが生成される
    And 通知キューに追加される
    And 空きスロットに通知カードが即座に表示される

  Scenario: 表示スロットが満杯の場合はキューで待機する
    Given 3つの表示スロットがすべて使用中である
    When 低優先度の通知が受信される
    Then 通知カードがキューに追加される
    And スロットが空いたらキューから取り出されて表示される

  Scenario: 高優先度通知が低優先度の表示を割り込む
    Given 3つの表示スロットがすべて低優先度の通知で使用中である
    When 高優先度の通知が受信される
    Then 最も古い低優先度の通知カードがスロットから退避される
    And 高優先度の通知カードが即座に表示される

  Scenario: 同一送信者からの連続メッセージをバンドルする
    Given ユーザー "Alice" からメッセージを受信し通知カードが表示されている
    When 3秒以内に "Alice" から追加のメッセージが受信される
    Then 新しい通知カードは生成されず既存カードの本文が更新される
    And 表示時間がリセットされる

  Scenario: 3秒を超えた場合はバンドルしない
    Given ユーザー "Alice" からメッセージを受信し通知カードが表示されている
    When 5秒後に "Alice" から追加のメッセージが受信される
    Then 新しい通知カードが別途生成される

  Scenario: 通知カードが表示後に自動的に既読になる
    Given 通知カードが "未読" 状態で表示されている
    When 表示時間が経過してカードが自動消去される
    Then 通知カードの状態が "既読" に遷移する

  Scenario: すべての通知カードが履歴に保存される
    When 通知カードが生成される
    Then 通知履歴に1件追加される
    And 履歴にはソース、送信者、本文、優先度、タイムスタンプが記録される

  Scenario: おやすみモードを有効にすると全通知が抑制される
    Given おやすみモードが "全抑制" で有効化されている
    When 通知イベントが受信される
    Then 通知カードは表示されない
    And 通知は履歴にのみ記録される

  Scenario: おやすみモードで高優先度のみ通過させる
    Given おやすみモードが "高優先度のみ通過" で有効化されている
    When 高優先度の通知イベントが受信される
    Then 通知カードが表示される
    When 低優先度の通知イベントが受信される
    Then 通知カードは表示されない

  Scenario: SteamVRが起動していない場合はオーバーレイ表示をスキップする
    Given SteamVRが起動していない
    When 通知イベントが受信される
    Then 通知カードは生成され履歴に記録される
    And オーバーレイ表示はスキップされる

# ============================================================
# Feature 4: 設定管理
# ============================================================

Feature: ユーザー設定とプロファイル管理
  VRユーザーとして
  設定を永続化しプロファイルで切り替えたい

  Scenario: 設定変更が自動的に永続化される
    Given システムが起動している
    When ユーザーが表示スロット数を "4" に変更する
    Then 設定が設定ファイルに保存される
    When システムを再起動する
    Then 表示スロット数が "4" で復元される

  Scenario: 設定ファイルが破損している場合はデフォルト設定で起動する
    Given 設定ファイルが破損している
    When システムが起動する
    Then デフォルト設定で起動する
    And 破損した設定ファイルのバックアップが作成される
    And ユーザーに設定リセットの通知が表示される

  Scenario: 認証トークンが暗号化されて保存される
    When ユーザーがDiscordのボットトークンを入力する
    Then トークンはDPAPIまたは同等の仕組みで暗号化される
    And 設定ファイルにはプレーンテキストのトークンが含まれない

  Scenario: 新しいプロファイルを作成する
    Given デフォルトプロファイルが存在する
    When ユーザーがプロファイル "仕事モード" を作成する
    Then プロファイル "仕事モード" が追加される
    And デフォルトプロファイルの設定がコピーされる

  Scenario: プロファイルを切り替える
    Given プロファイル "デフォルト" がアクティブである
    And プロファイル "仕事モード" が存在する
    When ユーザーがプロファイルを "仕事モード" に切り替える
    Then "仕事モード" のフィルタルールが適用される
    And "仕事モード" の通知ソース設定が適用される

  Scenario: デフォルトプロファイルは削除できない
    When ユーザーがプロファイル "デフォルト" を削除しようとする
    Then 削除が拒否される
    And 「デフォルトプロファイルは削除できません」というメッセージが表示される

  Scenario: 初回起動時のデフォルト設定
    Given システムが初めて起動される
    Then 以下のデフォルト設定が適用される:
      | 設定項目         | デフォルト値 |
      | 表示スロット数    | 3           |
      | 表示透明度       | 1.0         |
      | 高優先度表示時間  | 10秒        |
      | 中優先度表示時間  | 7秒         |
      | 低優先度表示時間  | 5秒         |
      | 履歴保持期間     | 7日         |
      | 履歴上限件数     | 1000件      |
      | おやすみモード    | 無効        |
      | フィルタデフォルト | 許可        |
      | バンドル間隔     | 3秒         |
